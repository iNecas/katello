<%= javascript_tag do %>

$(function() {
    var KT_AK_LABEL = "<%= kt_ak_label %>"
    var availableActivationKeys = $.parseJSON('{' +
                                              '"rhel6selfservice": ["Red Hat Enterprise Linux 6 Server Self-Service"],' +
                                              '"katello-and-friends": ["Katello", "Pulp", "Candlepin", "Foreman"],' +
                                              '"headpin-and-friends": ["Headpin", "Thumbslug", "Candlepin"] }');

    function ktFindAkParamContainer(){
        var ret;
        $("div#parameters div.control-group input[ type = 'text']").each(function () {
            element = $(this);
            if(element.val() == KT_AK_LABEL) {
                ret = element.parent();
                return false;
            }
        });
        return ret;
    }

    function ktOrganizations() {
        return $.grep($("#organizations label.organization"), function (el) {
            return $(el).text().trim().match(/^kt-/)
        });
    }

    function ktOrganizationsToKtEnv() {
        var ktOrgs = [], ktOrgsToEnvs = [], selectedEnvId;
        var ktEnvironmentSelect = $("#kt_environment_id");
        $.each(ktOrganizations(), function (i, label) {
            var input = $(label).find("input[ type = 'checkbox' ]");
            var frOrgName = $(label).text().trim();
            var frOrgId = input.val();
            var match = frOrgName.match(/^kt-\[(.*)\]\[(.*)\]$/);
            if(match) {
                if(input.attr('checked')) {
                    selectedEnvId = frOrgId;
                }
                var ktOrg = match[1]; ktEnv = match[2];
                if(ktOrgs.indexOf(ktOrg) == -1) {
                    ktOrgs.push(ktOrg);
                    ktOrgsToEnvs[ktOrg] = [];
                }
                ktOrgsToEnvs[ktOrg].push([frOrgId, ktEnv]);
            }
            $(this).parent().hide();
        });

        ktEnvironmentSelect.empty();
        var content = '<option value=""></option>';
        $.each(ktOrgs, function (i, org) {
            content += '<optgroup label="' + org + '">';
            $.each(ktOrgsToEnvs[org], function (j, env) {
                // we don't quotre the value beacuse of deface bug
                content += '<option value=';
                content += env[0];

                if(env[0] == selectedEnvId) {
                    content += " selected";
                }
                content += '>' + env[1] + '</option>';
            });
            content += '</optgroup>';
        });
        ktEnvironmentSelect.append(content);

    }

    function ktEnvToFrOrganizations() {
        var selectedEnvId = $("#kt_environment_id").val();
        $.each(ktOrganizations(), function (i, label) {
            var input = $(label).find("input[ type = 'checkbox' ]");
            if(selectedEnvId == input.val()) {
                input.prop("checked", true);
            } else {
                input.prop("checked", false);
            }
        });
    }

    function ktParamToAkInput() {
        var paramContainer = ktFindAkParamContainer();
        if(paramContainer) {
            $("#kt_activation_keys").val(paramContainer.find("textarea").val());
            paramContainer.hide();
        }
    }

    function ktAkInputToParam() {
        var ktActivationKeysValue = $("#kt_activation_keys").val().replace(/,\s*/g,",").replace(/,$/g,"");
        var paramContainer = ktFindAkParamContainer();
        if(ktActivationKeysValue) {
            if(! paramContainer) { // we create the param for kt_activation_keys
                $("div#parameters a.btn-success").click();
                paramContainer = $("div#parameters div.control-group").last();
                paramContainer.find("input").val(KT_AK_LABEL);
            }
            paramContainer.find("textarea").val(ktActivationKeysValue);
        } else if(paramContainer) {
            // we remove the param by setting destoy to 1
            paramContainer.find("input[ type = 'hidden' ]").val(1);
        }
    }

    function ktAkUpdateubscriptionsInfo() {
        var subsInfo = $("ul#ak-subscriptions-info");
        subsInfo.empty();
        var selectedKeys = $("#kt_activation_keys").val().split(/,\s*/);
        $.each(selectedKeys, function(i, key) {
          if(availableActivationKeys[key]) {
            // hack to make it working with deface
            var ul = "<ul>", ul_end = "</ul>", li = "<li>", li_end = "</li>";
            content = li + key + ul + li;
            content += availableActivationKeys[key].join(li_end + li);
            content += li_end + ul_end + li_end;
            subsInfo.append(content);
          }
        });
    }

    function ktOnLoad() {
        ktParamToAkInput();
        ktAkUpdateubscriptionsInfo();
        ktOrganizationsToKtEnv();
    };

    function ktOnSubmit() {
        ktAkInputToParam();
        ktEnvToFrOrganizations();
    }


    $("#kt_activation_keys").parents("form").submit(ktOnSubmit);

    ktOnLoad();

    $("#kt_activation_keys").autocomplete({
        minLength: 0,
        source: function(request, response) {
            var terms = request.term.split(/,\s*/);
            var part = terms.pop();
            var items = []
            for(key in availableActivationKeys) {
                if(terms.indexOf(key) == -1) {
                    items.push(key);
                }
            }
            response($.ui.autocomplete.filter(
                items, part));
        },
        focus: function() {
            // prevent value inserted on focus
            return false;
        },
        select: function(event, ui) {
            var oldTerms = this.value.replace(/[^, ][^,]*$/,"");
            this.value = oldTerms + ui.item.value;
            ktAkUpdateubscriptionsInfo();
            return false;
        },
        close: function() {
            ktAkUpdateubscriptionsInfo();
        }

    }).bind("focus", function(event) {
        if($(this)[0].value == "") {
	    $(this).autocomplete( "search" );
        }});

    $("#test").click(function () {
        ktAkInputToParam();
    });

});

<% end %>
<div class="tab-pane" id="katello">
  <%= field(nil, "Katello Environment") do
    select_tag(:kt_environment_id, [])
  end %>
  <%= field(nil, "Activation Keys", :help_inline => "comma separated values. The value will be available in templates as @#{kt_ak_label}") do
    text_field_tag("kt_activation_keys", "", :style => 'width: 98%')
  end %>
  <div class="alert alert-info">
    <p><b>Subscriptions information based on selected activation keys:</b></p>
    <ul id="ak-subscriptions-info">
    </ul>
    <p>Activation keys and subscriptions can be managed <b><a href="/katello" target="_blank">here</a></b></p>
  </div>
</div>
